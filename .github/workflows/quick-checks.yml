name: Quick Checks

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_call:
    outputs:
      passed:
        description: "Whether all quick checks passed"
        value: ${{ jobs.summary.outputs.passed }}

env:
  RUST_BACKTRACE: 1

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      if: ${{ !startsWith(runner.name, 'nektos/act') }}
      with:
        fetch-depth: 1

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - uses: Swatinem/rust-cache@v2

    - name: Format check
      run: cargo fmt --all -- --check

    - name: Run clippy (policy — lib/bins/examples)
      run: |
        cargo clippy --all-features --lib --bins --examples -- \
          -D warnings

    - name: Run clippy (tests)
      run: |
        # Run clippy on tests excluding broken property_tests
        cargo clippy --all-features --test quick -- -D warnings
        cargo clippy --all-features --test standard -- -D warnings
      continue-on-error: true  # Tests may have warnings

  quick-test:
    name: Quick Tests (<30s)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      if: ${{ !startsWith(runner.name, 'nektos/act') }}
      with:
        fetch-depth: 1

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Run quick tests
      run: |
        cargo test --lib --release -- --test-threads=4
      timeout-minutes: 5

  check:
    name: Cargo Check
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        exclude:
          - os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      if: ${{ !startsWith(runner.name, 'nektos/act') }}
      with:
        fetch-depth: 1

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Check compilation
      run: cargo check --lib --bins --examples
      # Note: --all-targets excluded because property_tests need fixes

  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      if: ${{ !startsWith(runner.name, 'nektos/act') }}
      with:
        fetch-depth: 1

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Check for unused dependencies
      run: |
        cargo install cargo-machete --locked || true
        cargo machete || true

    - name: Check for outdated dependencies
      run: |
        cargo install cargo-outdated --locked || true
        cargo outdated --exit-code 1 || true

  license-check:
    name: License Header Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      if: ${{ !startsWith(runner.name, 'nektos/act') }}
      with:
        fetch-depth: 1

    - name: Check license headers
      run: |
        missing_headers=0
        for file in $(find src tests examples -name "*.rs" -type f); do
          if ! head -10 "$file" | grep -q -E "(MIT|Apache|License)"; then
            echo "::warning file=$file::Missing license header"
            missing_headers=$((missing_headers + 1))
          fi
        done

        if [ $missing_headers -gt 0 ]; then
          echo "::warning::Found $missing_headers files without license headers"
        fi

  yaml-lint:
    name: YAML/TOML Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Note
      run: echo "Skipping actionlint; running TOML validation only"

    - name: Validate TOML files
      run: |
        find . -name "Cargo.toml" -exec cargo verify-project --manifest-path {} \;
      continue-on-error: true

  summary:
    name: Quick Checks Summary
    needs: [lint, check, dependencies, license-check, yaml-lint]
    runs-on: ubuntu-latest
    if: always()
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
    - name: Summary
      id: check
      run: |
        if [[ "${{ needs.lint.result }}" == "success" && \
              "${{ needs.check.result }}" == "success" && \
              "${{ needs.yaml-lint.result }}" == "success" ]]; then
          echo "✅ All quick checks passed!"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          echo "❌ Some quick checks failed!"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Report Status
      if: always()
      run: |
        echo "### Quick Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Clippy | ${{ needs.lint.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Compilation | ${{ needs.check.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | ${{ needs.dependencies.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| License Headers | ${{ needs.license-check.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| YAML/TOML | ${{ needs.yaml-lint.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Time: $(date -u)" >> $GITHUB_STEP_SUMMARY
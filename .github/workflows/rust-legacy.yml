name: Extended Platform Tests

on:
  push:
    branches: ['master', '0.8.x']
  schedule:
    - cron: "21 3 * * 5"

jobs:
  test-freebsd:
  # see https://github.com/actions/runner/issues/385
  # use https://github.com/vmactions/freebsd-vm for now
    name: test on freebsd
    runs-on: ubuntu-latest
    continue-on-error: true  # Exotic platform - transient issues expected
    steps:
      - uses: actions/checkout@v4
      - name: test on freebsd
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          mem: 4096
          copyback: false
          prepare: |
            pkg install -y curl cmake
            curl https://sh.rustup.rs -sSf --output rustup.sh
            sh rustup.sh -y --profile minimal --default-toolchain stable
          run: |
            export PATH="$HOME/.cargo/bin:$PATH"
            echo "===== rustc --version ====="
            rustc --version
            echo "===== freebsd-version ====="
            freebsd-version

            # Build and test excluding broken property_tests
            cargo build --locked --lib --bins --examples && cargo test --locked --lib && cargo test --locked --lib -- --ignored stress

  test-netbsd:
    name: test on netbsd
    runs-on: ubuntu-latest
    continue-on-error: true  # Exotic platform - transient issues expected
    steps:
      - uses: actions/checkout@v4
      - name: test on netbsd
        uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          mem: 4096
          copyback: false
          prepare: |
            export PATH="/usr/sbin:/sbin:$PATH"
            pkg_add curl
            curl https://sh.rustup.rs -sSf --output rustup.sh
            sh rustup.sh -y --profile minimal --default-toolchain stable
          run: |
            export PATH="$HOME/.cargo/bin:$PATH"
            echo "===== rustc --version ====="
            rustc --version
            echo "===== uname -a        ====="
            uname -a

            # Build and test excluding broken property_tests
            cargo build --locked --lib --bins --examples && cargo test --locked --lib && cargo test --locked --lib -- --ignored stress

  test-solaris:
    name: test on solaris
    runs-on: ubuntu-latest
    continue-on-error: true  # Exotic platform - transient issues expected
    steps:
      - uses: actions/checkout@v4
      - name: test on Solaris
        uses: vmactions/solaris-vm@v1
        with:
          release: "11.4-gcc"
          usesh: true
          mem: 4096
          copyback: false
          prepare: |
            source <(curl -s https://raw.githubusercontent.com/psumbera/solaris-rust/refs/heads/main/sh.rust-web-install)
            echo "~~~~ rustc --version ~~~~"
            rustc --version
            echo "~~~~ Solaris-version ~~~~"
            uname -a
          # Unlike others, don't un-ignore stress tests, because they hang on Solaris
          run: |
            export PATH=$HOME/.rust_solaris/bin:$PATH
            # Workaround for https://github.com/quinn-rs/quinn/issues/2218
            export CARGO_HTTP_MULTIPLEXING=false
            # Build and test excluding broken property_tests
            cargo build --locked --lib --bins --examples && cargo test --locked --lib

  test-illumos:
    name: test on illumos
    runs-on: ubuntu-latest
    continue-on-error: true  # Exotic platform - transient issues expected
    steps:
      - uses: actions/checkout@v4
      - name: test on Illumos
        uses: vmactions/omnios-vm@v1
        with:
          usesh: true
          mem: 4096
          copyback: false
          prepare: |
            pkg install gcc14 curl pkg-config glib2
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
          run: |
            . "$HOME/.cargo/env"
            # Build and test excluding broken property_tests
            cargo build --locked --lib --bins --examples && cargo test --locked --lib && cargo test --locked --lib -- --ignored stress

  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        exclude:
          - os: macos-latest
            rust: beta
          - os: windows-latest
            rust: beta

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
      # Build and test excluding broken property_tests
      - run: cargo build --locked --lib --bins --examples
      - run: cargo test --locked --lib
      # Fast apple datapath tests removed - ant-quic integrated package
      - run: cargo test --locked --lib -- --ignored stress
      - name: Test fuzz (if exists)
        run: |
          if [ -f "fuzz/Cargo.toml" ]; then
            cargo test --locked --manifest-path fuzz/Cargo.toml
          else
            echo "fuzz/Cargo.toml not found, skipping"
          fi
        if: ${{ matrix.rust == 'stable' }}
      # Benchmark tests removed - ant-quic integrated package

  test-aws-lc-rs:
    runs-on: ubuntu-latest
    # PQC crypto code has hardcoded ring dependencies, so aws-lc-rs is incompatible
    # This job is kept for tracking but marked as continue-on-error
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      # NOTE: PQC features have hardcoded ring imports, tests will fail with aws-lc-rs only
      # Prevent feature unification from selecting *ring* as the crypto provider
      - run: RUST_BACKTRACE=1 cargo test --locked --lib --no-default-features --features rustls-aws-lc-rs
      - run: RUST_BACKTRACE=1 cargo test --locked --lib --no-default-features --features rustls-aws-lc-rs,runtime-tokio
      # FIPS
      - run: RUST_BACKTRACE=1 cargo test --locked --lib --no-default-features --features rustls-aws-lc-rs-fips
      - run: RUST_BACKTRACE=1 cargo test --locked --lib --no-default-features --features rustls-aws-lc-rs-fips,runtime-tokio

  msrv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Note that we must also update the README when changing the MSRV
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.85.0
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --locked --lib --all-features

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --all -- --check
      # Check and clippy excluding broken property_tests
      # Note: --no-default-features alone fails (no crypto provider), so we add rustls-ring
      - run: cargo check --locked --lib --bins --examples --no-default-features --features rustls-ring
      - run: cargo clippy --locked --lib --bins --examples -- -D warnings
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: doc
        run: cargo doc --locked --no-deps --document-private-items
        env:
          RUSTDOCFLAGS: -Dwarnings
      - name: lint fuzz
        run: |
          if [ -d "fuzz" ]; then
            cd fuzz
            cargo clippy --locked -- -D warnings
          else
            echo "fuzz directory not found, skipping"
          fi

  audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: EmbarkStudios/cargo-deny-action@v2

  test-android:
    runs-on: ubuntu-latest
    continue-on-error: true  # aws-lc-rs has bindgen issues on Android

    strategy:
      matrix:
        target: [x86_64-linux-android, i686-linux-android]
        emulator-arch: [x86_64, x86]
        api-level: [26, 25]
        exclude:
          - target: x86_64-linux-android
            emulator-arch: x86
          - target: i686-linux-android
            emulator-arch: x86_64

    steps:
    - name: Set API level environment variable
      run: echo "API_LEVEL=${{ matrix.api-level }}" >> $GITHUB_ENV

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '21'

    - name: Install Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android NDK
      run: sdkmanager --install "ndk;25.2.9519653"

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: ${{ matrix.target }}

    - uses: Swatinem/rust-cache@v2

    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    - name: Build unit tests for Android
      run: cargo ndk -t ${{ matrix.target }} test --no-run

    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Set up Android Emulator and run tests
      env:
        TARGET: ${{ matrix.target }}
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        arch: ${{ matrix.emulator-arch }}
        script: .github/workflows/rust-android-run-tests-on-emulator.sh

  features:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    continue-on-error: true  # Feature powerset is advisory, not blocking
    env:
      RUSTFLAGS: -Dwarnings
      # skip pqc, aws-lc-rs (code has hardcoded ring deps), FIPS, and property_testing
      SKIP_FEATURES: ${{ matrix.os != 'ubuntu-latest' && 'rustls-aws-lc-rs,rustls-aws-lc-rs-fips,aws-lc-rs,aws-lc-rs-fips,pqc,property_testing' || 'rustls-aws-lc-rs,aws-lc-rs,pqc,property_testing' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@cargo-hack
      # Skip aws-lc-rs combinations (code requires ring unconditionally)
      # Skip pqc (has hardcoded ring deps) and property_testing (has compile errors)
      # Use --include-features to ensure rustls-ring is always included
      - run: cargo hack check --feature-powerset --depth 2 --optional-deps --no-dev-deps --ignore-private --skip "${{env.SKIP_FEATURES}}" --include-features rustls-ring

# Tests - Comprehensive test suite for library, integration, and property tests
# Runs on every push/PR and provides scheduled extended testing

name: Tests

on:
  workflow_call:
    inputs:
      test_depth:
        description: 'Test depth (quick/standard/extended)'
        required: false
        default: 'standard'
        type: string
    outputs:
      passed:
        description: "Whether all tests passed"
        value: ${{ jobs.summary.outputs.passed }}
  workflow_dispatch:
    inputs:
      test_depth:
        description: 'Test depth'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - extended
      run_mutation:
        description: 'Run mutation tests'
        type: boolean
        default: false
  push:
    branches: [master, main]
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
  pull_request:
    branches: [master, main]
  schedule:
    # Extended tests weekly on Mondays at 4 AM UTC
    - cron: '0 4 * * 1'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  PROPTEST_CASES: ${{ github.event.inputs.test_depth == 'extended' && '1024' || '256' }}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Core library tests
  lib-tests:
    name: Library Tests (${{ matrix.os }} / ${{ matrix.rust }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          - os: ubuntu-latest
            rust: beta
          - os: ubuntu-latest
            rust: nightly
    continue-on-error: ${{ matrix.rust != 'stable' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: lib-${{ matrix.os }}-${{ matrix.rust }}

      - name: Run library tests
        run: cargo test --lib --all-features -- --test-threads=2

      - name: Run doc tests
        if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
        run: cargo test --doc

  # Integration tests
  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: integration-${{ matrix.os }}

      - name: Run integration tests
        run: |
          cargo test --test quick --features "test-utils" -- --test-threads=2 --skip auto_binding --skip binding_stream
          cargo test --test standard --features "test-utils" -- --test-threads=2
        shell: bash

  # Feature combination tests
  feature-tests:
    name: Feature Combinations
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: features

      - name: Test minimal features
        run: cargo test --lib --no-default-features --features "rustls-aws-lc-rs"

      - name: Test all features
        run: cargo test --lib --all-features

      - name: Test aws-lc-rs crypto provider
        run: |
          cargo test --lib --no-default-features --features "rustls-aws-lc-rs"
          cargo test --lib --no-default-features --features "rustls-aws-lc-rs,runtime-tokio"
        continue-on-error: true  # aws-lc-rs has some PQC compatibility issues

  # Property-based tests
  property-tests:
    name: Property Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    continue-on-error: true  # Property tests need fixes - non-blocking
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        include:
          - os: windows-latest
          - os: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: proptest-${{ matrix.os }}

      - name: Run property tests
        run: cargo test --test property_tests --release -- --test-threads=4
        env:
          PROPTEST_CASES: ${{ env.PROPTEST_CASES }}
          PROPTEST_MAX_SHRINK_ITERS: 10000

      - name: Upload regression files
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: proptest-regressions-${{ matrix.os }}
          path: proptest-regressions/

  # Extended property tests (schedule/manual only)
  extended-property-tests:
    name: Extended Property Tests
    if: github.event_name == 'schedule' || github.event.inputs.test_depth == 'extended'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: proptest-extended

      - name: Run extended property tests
        run: cargo test --test property_tests --release -- --test-threads=8
        env:
          PROPTEST_CASES: 1024
          PROPTEST_MAX_SHRINK_ITERS: 50000

  # Mutation testing (schedule/manual only)
  mutation-tests:
    name: Mutation Tests
    if: github.event_name == 'schedule' || github.event.inputs.run_mutation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    continue-on-error: true  # Informational only
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: mutation

      - name: Install cargo-mutants
        run: cargo install cargo-mutants --locked

      - name: Run mutation testing
        run: |
          cargo mutants --no-shuffle --timeout-multiplier 2.0 \
            --exclude "tests/*" \
            --exclude "examples/*" \
            --exclude "benches/*" \
            --in-diff HEAD~1..HEAD || echo "Mutation testing completed"

      - name: Upload mutation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-results
          path: mutants.out/

  # Stress tests (schedule/manual only)
  stress-tests:
    name: Stress Tests
    if: github.event_name == 'schedule' || github.event.inputs.test_depth == 'extended'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          key: stress

      - name: Run stress tests
        run: cargo test --lib -- --ignored stress --test-threads=1

  # Summary job
  summary:
    name: Test Summary
    needs: [lib-tests, integration-tests, feature-tests, property-tests]
    if: always()
    runs-on: ubuntu-latest
    outputs:
      passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Check test results
        id: check
        run: |
          # Core tests must pass
          if [ "${{ needs.lib-tests.result }}" != "success" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ "${{ needs.feature-tests.result }}" != "success" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          # Property tests are non-blocking (continue-on-error)
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Generate summary
        if: always()
        run: |
          echo "# Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Library Tests | ${{ needs.lib-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Combinations | ${{ needs.feature-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Property Tests | ${{ needs.property-tests.result }} |" >> $GITHUB_STEP_SUMMARY

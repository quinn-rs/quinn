# Deploy to DigitalOcean - Auto-deploy on release
# Deploys ant-quic binaries to DO nodes when a GitHub release is published

name: Deploy to DigitalOcean

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to deploy (e.g., v0.14.64)'
        required: true
      binary:
        description: 'Binary to deploy'
        type: choice
        options:
          - ant-quic
          - ant-quic-test
        default: ant-quic
      dry_run:
        description: 'Dry run (download only, no deploy)'
        type: boolean
        default: false

env:
  # Default binary (overridden for ant-quic-test)
  DEFAULT_BINARY: ant-quic
  DEFAULT_REMOTE_PATH: /usr/local/bin/ant-quic
  DEFAULT_SERVICE: ant-quic

jobs:
  deploy:
    name: Deploy to ${{ matrix.node.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node:
          - name: saorsa-2
            host: 142.93.199.50
            description: "Bootstrap Node (NYC1)"
          - name: saorsa-3
            host: 147.182.234.192
            description: "Bootstrap Node (SFO3)"
          - name: saorsa-4
            host: 206.189.7.117
            description: "Test Node (AMS3)"
          - name: saorsa-5
            host: 144.126.230.161
            description: "Test Node (LON1)"
          - name: saorsa-6
            host: 65.21.157.229
            description: "Test Node - Hetzner (Helsinki)"
          - name: saorsa-7
            host: 116.203.101.172
            description: "Test Node - Hetzner (Nuremberg)"
          - name: saorsa-8
            host: 149.28.156.231
            description: "Test Node - Vultr (Singapore)"
          - name: saorsa-9
            host: 45.77.176.184
            description: "Test Node - Vultr (Tokyo)"

    steps:
      - name: Determine version and binary
        id: config
        run: |
          # Determine version
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            BINARY="ant-quic"  # Default for auto-deploy on release
          else
            VERSION="${{ github.event.inputs.version }}"
            BINARY="${{ github.event.inputs.binary }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "binary=$BINARY" >> $GITHUB_OUTPUT

          # Set binary-specific paths
          if [[ "$BINARY" == "ant-quic-test" ]]; then
            echo "archive=ant-quic-test-x86_64-linux.tar.gz" >> $GITHUB_OUTPUT
            echo "remote_path=/opt/ant-quic-test/ant-quic-test" >> $GITHUB_OUTPUT
            echo "service=ant-quic-test" >> $GITHUB_OUTPUT
          else
            echo "archive=ant-quic-x86_64-linux.tar.gz" >> $GITHUB_OUTPUT
            echo "remote_path=/usr/local/bin/ant-quic" >> $GITHUB_OUTPUT
            echo "service=ant-quic" >> $GITHUB_OUTPUT
          fi

          echo "Deploying $BINARY version: $VERSION to ${{ matrix.node.name }}"

      - name: Download Linux binary from release
        run: |
          VERSION="${{ steps.config.outputs.version }}"
          BINARY="${{ steps.config.outputs.binary }}"
          ARCHIVE="${{ steps.config.outputs.archive }}"

          echo "Downloading $ARCHIVE from release $VERSION..."
          gh release download "$VERSION" \
            --repo "${{ github.repository }}" \
            --pattern "$ARCHIVE"

          echo "Extracting binary..."
          tar -xzf "$ARCHIVE"
          chmod +x "$BINARY"

          echo "Binary info:"
          file "$BINARY"
          ./"$BINARY" --version || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ matrix.node.host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Pre-deployment health check
        continue-on-error: true
        run: |
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"
          echo "Checking current status on ${{ matrix.node.name }}..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            root@${{ matrix.node.host }} \
            "systemctl status $SERVICE || true; $REMOTE_PATH --version || echo 'Binary not found or not running'"

      - name: Deploy binary
        if: github.event.inputs.dry_run != 'true'
        run: |
          BINARY="${{ steps.config.outputs.binary }}"
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"

          echo "Deploying $BINARY to ${{ matrix.node.name }} (${{ matrix.node.host }})..."

          # Upload new binary
          scp -i ~/.ssh/deploy_key \
            "$BINARY" root@${{ matrix.node.host }}:/tmp/binary-new

          # Stop service, replace binary, restart
          ssh -i ~/.ssh/deploy_key root@${{ matrix.node.host }} << EOF
          set -e

          echo "Stopping service..."
          systemctl stop $SERVICE 2>/dev/null || true
          sleep 2

          # Kill any remaining processes
          pkill -9 $BINARY 2>/dev/null || true
          sleep 1

          echo "Replacing binary..."
          # Clean up any existing file at the directory path (legacy deployments)
          if [ -f /opt/ant-quic-test ]; then
            echo "Removing legacy binary at /opt/ant-quic-test..."
            rm -f /opt/ant-quic-test
          fi
          mkdir -p /opt/ant-quic-test
          mv /tmp/binary-new $REMOTE_PATH
          chmod +x $REMOTE_PATH

          echo "Verifying binary can execute..."
          $REMOTE_PATH --version || echo "WARNING: Binary failed version check"

          # Always recreate systemd service file to ensure correct paths
          echo "Creating/updating systemd service file for $SERVICE..."
          echo "[Unit]" > /etc/systemd/system/$SERVICE.service
          echo "Description=$SERVICE Test Network Node" >> /etc/systemd/system/$SERVICE.service
          echo "After=network-online.target" >> /etc/systemd/system/$SERVICE.service
          echo "Wants=network-online.target" >> /etc/systemd/system/$SERVICE.service
          echo "" >> /etc/systemd/system/$SERVICE.service
          echo "[Service]" >> /etc/systemd/system/$SERVICE.service
          echo "Type=simple" >> /etc/systemd/system/$SERVICE.service
          echo "User=root" >> /etc/systemd/system/$SERVICE.service
          echo "ExecStart=$REMOTE_PATH --registry-url https://saorsa-1.saorsalabs.com --quiet" >> /etc/systemd/system/$SERVICE.service
          echo "Restart=always" >> /etc/systemd/system/$SERVICE.service
          echo "RestartSec=5" >> /etc/systemd/system/$SERVICE.service
          echo "StandardOutput=append:/var/log/$SERVICE.log" >> /etc/systemd/system/$SERVICE.service
          echo "StandardError=append:/var/log/$SERVICE.log" >> /etc/systemd/system/$SERVICE.service
          echo "Environment=RUST_LOG=info" >> /etc/systemd/system/$SERVICE.service
          echo "" >> /etc/systemd/system/$SERVICE.service
          echo "[Install]" >> /etc/systemd/system/$SERVICE.service
          echo "WantedBy=multi-user.target" >> /etc/systemd/system/$SERVICE.service
          systemctl daemon-reload

          echo "Starting service..."
          systemctl start $SERVICE || echo "Service $SERVICE failed to start"
          sleep 3

          echo "Verifying..."
          systemctl status $SERVICE --no-pager || echo "Service not running"
          $REMOTE_PATH --version || echo "Binary version check failed"
          EOF

      - name: Post-deployment verification
        if: github.event.inputs.dry_run != 'true'
        run: |
          BINARY="${{ steps.config.outputs.binary }}"
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"

          echo "Verifying deployment on ${{ matrix.node.name }}..."
          sleep 5

          ssh -i ~/.ssh/deploy_key root@${{ matrix.node.host }} << EOF
          echo "=== Service Status ==="
          systemctl status $SERVICE --no-pager || echo "Service not active"

          echo ""
          echo "=== Binary Version ==="
          $REMOTE_PATH --version

          echo ""
          echo "=== Process Check ==="
          pgrep -a $BINARY || echo "Warning: $BINARY not running"

          echo ""
          echo "=== Port Check ==="
          ss -tulpn | grep 9000 || echo "Warning: Port 9000 not listening"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  notify:
    name: Deployment Summary
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            BINARY="ant-quic"
          else
            VERSION="${{ github.event.inputs.version }}"
            BINARY="${{ github.event.inputs.binary }}"
          fi

          echo "**Binary:** $BINARY" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Node Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Node | IP | Provider/Region | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-2 | 142.93.199.50 | DO NYC1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-3 | 147.182.234.192 | DO SFO3 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-4 | 206.189.7.117 | DO AMS3 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-5 | 144.126.230.161 | DO LON1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-6 | 65.21.157.229 | Hetzner Helsinki | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-7 | 116.203.101.172 | Hetzner Nuremberg | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-8 | 149.28.156.231 | Vultr Singapore | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| saorsa-9 | 45.77.176.184 | Vultr Tokyo | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY

# Deploy to DigitalOcean - Auto-deploy on release
# Deploys ant-quic binaries to DO nodes when a GitHub release is published

name: Deploy to DigitalOcean

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to deploy (e.g., v0.14.64)'
        required: true
      binary:
        description: 'Binary to deploy'
        type: choice
        options:
          - ant-quic
          - ant-quic-test
        default: ant-quic
      dry_run:
        description: 'Dry run (download only, no deploy)'
        type: boolean
        default: false

env:
  # Default binary (overridden for ant-quic-test)
  DEFAULT_BINARY: ant-quic
  DEFAULT_REMOTE_PATH: /usr/local/bin/ant-quic
  DEFAULT_SERVICE: ant-quic

jobs:
  deploy:
    name: Deploy to ${{ matrix.node.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node:
          - name: node-1
            host: 162.243.167.201
            description: "Primary coordinator node (nyc1)"
          - name: node-2
            host: 159.65.221.230
            description: "Secondary node (nyc1)"
          - name: nat-fullcone
            host: 67.205.158.158
            description: "Full Cone NAT simulation (nyc1)"
          - name: nat-restricted
            host: 161.35.231.80
            description: "Address Restricted NAT simulation (sfo3)"
          - name: nat-portrestricted
            host: 178.62.192.11
            description: "Port Restricted NAT simulation (ams3)"
          - name: nat-symmetric
            host: 159.65.90.128
            description: "Symmetric NAT simulation (lon1)"

    steps:
      - name: Determine version and binary
        id: config
        run: |
          # Determine version
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            BINARY="ant-quic"  # Default for auto-deploy on release
          else
            VERSION="${{ github.event.inputs.version }}"
            BINARY="${{ github.event.inputs.binary }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "binary=$BINARY" >> $GITHUB_OUTPUT

          # Set binary-specific paths
          if [[ "$BINARY" == "ant-quic-test" ]]; then
            echo "archive=ant-quic-test-x86_64-linux.tar.gz" >> $GITHUB_OUTPUT
            echo "remote_path=/usr/local/bin/ant-quic-test" >> $GITHUB_OUTPUT
            echo "service=ant-quic-test" >> $GITHUB_OUTPUT
          else
            echo "archive=ant-quic-x86_64-linux.tar.gz" >> $GITHUB_OUTPUT
            echo "remote_path=/usr/local/bin/ant-quic" >> $GITHUB_OUTPUT
            echo "service=ant-quic" >> $GITHUB_OUTPUT
          fi

          echo "Deploying $BINARY version: $VERSION to ${{ matrix.node.name }}"

      - name: Download Linux binary from release
        run: |
          VERSION="${{ steps.config.outputs.version }}"
          BINARY="${{ steps.config.outputs.binary }}"
          ARCHIVE="${{ steps.config.outputs.archive }}"

          echo "Downloading $ARCHIVE from release $VERSION..."
          gh release download "$VERSION" \
            --repo "${{ github.repository }}" \
            --pattern "$ARCHIVE"

          echo "Extracting binary..."
          tar -xzf "$ARCHIVE"
          chmod +x "$BINARY"

          echo "Binary info:"
          file "$BINARY"
          ./"$BINARY" --version || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ matrix.node.host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Pre-deployment health check
        continue-on-error: true
        run: |
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"
          echo "Checking current status on ${{ matrix.node.name }}..."
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            root@${{ matrix.node.host }} \
            "systemctl status $SERVICE || true; $REMOTE_PATH --version || echo 'Binary not found or not running'"

      - name: Deploy binary
        if: github.event.inputs.dry_run != 'true'
        run: |
          BINARY="${{ steps.config.outputs.binary }}"
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"

          echo "Deploying $BINARY to ${{ matrix.node.name }} (${{ matrix.node.host }})..."

          # Upload new binary
          scp -i ~/.ssh/deploy_key \
            "$BINARY" root@${{ matrix.node.host }}:/tmp/binary-new

          # Stop service, replace binary, restart
          ssh -i ~/.ssh/deploy_key root@${{ matrix.node.host }} << EOF
          set -e

          echo "Stopping service..."
          systemctl stop $SERVICE || true
          sleep 2

          # Kill any remaining processes
          pkill -9 $BINARY || true
          sleep 1

          echo "Replacing binary..."
          mv /tmp/binary-new $REMOTE_PATH
          chmod +x $REMOTE_PATH

          echo "Starting service..."
          systemctl start $SERVICE || echo "Service $SERVICE not configured, skipping start"
          sleep 3

          echo "Verifying..."
          systemctl status $SERVICE --no-pager || echo "Service not running"
          $REMOTE_PATH --version
          EOF

      - name: Post-deployment verification
        if: github.event.inputs.dry_run != 'true'
        run: |
          BINARY="${{ steps.config.outputs.binary }}"
          REMOTE_PATH="${{ steps.config.outputs.remote_path }}"
          SERVICE="${{ steps.config.outputs.service }}"

          echo "Verifying deployment on ${{ matrix.node.name }}..."
          sleep 5

          ssh -i ~/.ssh/deploy_key root@${{ matrix.node.host }} << EOF
          echo "=== Service Status ==="
          systemctl status $SERVICE --no-pager || echo "Service not active"

          echo ""
          echo "=== Binary Version ==="
          $REMOTE_PATH --version

          echo ""
          echo "=== Process Check ==="
          pgrep -a $BINARY || echo "Warning: $BINARY not running"

          echo ""
          echo "=== Port Check ==="
          ss -tulpn | grep 9000 || echo "Warning: Port 9000 not listening"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  notify:
    name: Deployment Summary
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            BINARY="ant-quic"
          else
            VERSION="${{ github.event.inputs.version }}"
            BINARY="${{ github.event.inputs.binary }}"
          fi

          echo "**Binary:** $BINARY" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Node Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Node | IP | Region | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| node-1 | 162.243.167.201 | nyc1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| node-2 | 159.65.221.230 | nyc1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nat-fullcone | 67.205.158.158 | nyc1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nat-restricted | 161.35.231.80 | sfo3 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nat-portrestricted | 178.62.192.11 | ams3 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nat-symmetric | 159.65.90.128 | lon1 | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
